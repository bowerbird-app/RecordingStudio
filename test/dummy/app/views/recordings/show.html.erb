<% content_for :title, "Recording" %>

<div class="space-y-3">
    <%= link_to "Back", pages_path, class: "text-sm font-medium text-slate-600 hover:text-slate-900" %>
  <div class="w-full rounded-lg border border-slate-200 bg-white p-6">
    <p class="text-sm uppercase tracking-wide text-slate-500">Recording</p>
    <h2 class="text-2xl font-semibold"><%= @recording.recordable.title %></h2>
    <p class="mt-2 text-sm text-slate-600"><%= @recording.recordable.summary %></p>
    <div class="mt-4 flex flex-wrap items-center gap-2">
      <% if @recording.trashed_at %>
        <%= button_to "Restore", restore_page_path(@recording), method: :post, class: "inline-flex rounded-md border border-emerald-300 px-3 py-2 text-sm font-medium text-emerald-700", form: { data: { turbo_confirm: "Restore this page and its children?" } } %>
      <% else %>
        <%= link_to "Edit", edit_page_path(@recording), class: "inline-flex rounded-md border border-slate-300 px-3 py-2 text-sm font-medium text-slate-700" %>
        <%= button_to "Trash", page_path(@recording), method: :delete, class: "inline-flex rounded-md border border-rose-300 px-3 py-2 text-sm font-medium text-rose-700", form: { data: { turbo_confirm: "Trash this page and its children?" } } %>
      <% end %>
    </div>
  </div>

  <% child_recordings = @recording.child_recordings.including_trashed.recent %>
  <div class="w-full rounded-lg border border-slate-200 bg-white p-6">
    <p class="text-sm uppercase tracking-wide text-slate-500">Child recordings</p>
    <% if child_recordings.any? %>
      <div class="mt-4 space-y-3">
        <% child_recordings.each do |child| %>
          <div class="rounded-md border border-slate-200 p-4">
            <div class="flex flex-wrap items-center gap-2 text-sm font-medium text-slate-900">
              <span><%= recordable_label(child.recordable) %></span>
              <% if child.trashed_at.present? %>
                <span class="rounded-full bg-amber-100 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-amber-700">Trashed</span>
              <% end %>
            </div>
            <% if child.recordable.respond_to?(:body) && child.recordable.body.present? %>
              <div class="mt-2 text-sm text-slate-600"><%= child.recordable.body %></div>
            <% end %>
            <div class="mt-2 text-xs text-slate-500">Recording ID: <%= child.id %></div>
            <div class="mt-1 text-xs text-slate-500">Parent Recording ID: <%= child.parent_recording_id %></div>
            <div class="mt-1 text-xs text-slate-500">Status: <%= child.trashed_at ? "Trashed" : "Active" %></div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="mt-2 text-sm text-slate-600">No child recordings yet.</p>
    <% end %>
  </div>
</div>

<div class="mt-8 space-y-6">
  <section class="space-y-6">
    <div class="rounded-lg border border-slate-200 bg-white p-6">
      <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Recording Snapshot</h3>
      <dl class="mt-4 grid gap-4 text-sm sm:grid-cols-2 lg:grid-cols-3">
        <div>
          <dt class="text-slate-500">Original ID</dt>
          <dd class="font-medium text-slate-900"><%= @recording.recordable.original_id || @recording.recordable.id %></dd>
        </div>
        <div>
          <dt class="text-slate-500">Last updated</dt>
          <dd class="font-medium text-slate-900"><%= l(@recording.updated_at, format: :long) %></dd>
        </div>
        <div>
          <dt class="text-slate-500">Container</dt>
          <dd class="font-medium text-slate-900"><%= @recording.container_type %></dd>
        </div>
        <div>
          <dt class="text-slate-500">Container ID</dt>
          <dd class="font-medium text-slate-900"><%= @recording.container_id %></dd>
        </div>
        <div>
          <dt class="text-slate-500">Status</dt>
          <dd class="font-medium text-slate-900"><%= @recording.trashed_at ? "Trashed" : "Active" %></dd>
        </div>
      </dl>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <div class="rounded-lg border border-slate-200 bg-white p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">History</h3>
        </div>
        <p class="mt-2 text-sm text-slate-600">
          Each entry captures what changed for this page at a point in time, including actor and recordable context.
        </p>
        <div class="mt-4 space-y-4">
          <% current_recordable_id = @recording.recordable.id %>
          <% current_event_id = @events.find { |entry| entry.recordable&.id == current_recordable_id && !%w[trashed deleted restored].include?(entry.action) }&.id %>
          <% @events.each do |event| %>
            <div class="rounded-md border border-slate-200 p-4">
              <div class="text-sm">
                <div class="flex flex-wrap items-center gap-2 font-semibold text-slate-900">
                  <span><%= event.action %></span>
                  <% if current_event_id && event.id == current_event_id %>
                    <span class="rounded-full bg-slate-900 px-2 py-0.5 text-xs font-semibold text-white">Current</span>
                  <% end %>
                </div>
                <div class="mt-1 text-slate-500" title="<%= l(event.occurred_at, format: :long) %>">
                  <%= time_ago_in_words(event.occurred_at) %> ago
                </div>
              </div>
              <div class="mt-2 text-xs text-slate-500">
                Actor: <span class="font-medium text-slate-700"><%= actor_with_impersonator_label(event.actor, event.impersonator) %></span>
              </div>
              <div class="mt-2 text-xs text-slate-500">
                Recordable: <span class="font-medium text-slate-700"><%= recordable_label(event.recordable) %></span>
              </div>
              <div class="mt-2 text-xs text-slate-500">
                Previous: <span class="font-medium text-slate-700"><%= recordable_label(event.previous_recordable) %></span>
              </div>
              <% if event.metadata.present? %>
                <div class="mt-2 rounded bg-slate-50 px-3 py-2 text-xs text-slate-600">
                  <%= JSON.pretty_generate(event.metadata) %>
                </div>
              <% end %>

              <% if event.recordable && event.recordable.id != @recording.recordable.id %>
                <div class="mt-3">
                  <%= button_to "Revert to this", revert_recording_path(@recording, recordable_id: event.recordable.id), method: :post, class: "inline-flex rounded-md border border-slate-300 px-3 py-2 text-xs font-medium text-slate-700" %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="rounded-lg border border-slate-200 bg-white p-6">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Recordables</h3>
        <p class="mt-2 text-sm text-slate-600">
          All snapshots referenced by this recording, including previous versions.
        </p>
        <div class="mt-4 space-y-3">
          <% @recordables.each do |recordable| %>
            <div class="rounded-md border border-slate-200 p-4">
              <% if recordable.id == @recording.recordable.id %>
                <div>
                  <span class="rounded-full bg-slate-900 px-2 py-0.5 text-xs font-semibold text-white">Current</span>
                </div>
              <% end %>
              <div class="mt-2 text-sm font-medium text-slate-900">
                <%= recordable_label(recordable) %>
              </div>
              <% if recordable.respond_to?(:summary) && recordable.summary.present? %>
                <div class="mt-2 text-xs text-slate-500"><%= recordable.summary %></div>
              <% end %>
              <div class="mt-2 text-xs text-slate-500">
                Recordings pointing here: <%= recordable.respond_to?(:recordings_count) ? recordable.recordings_count : 0 %>
              </div>
              <div class="mt-1 text-xs text-slate-500">
                Events pointing here: <%= recordable.respond_to?(:events_count) ? recordable.events_count : 0 %>
              </div>
              <div class="mt-1 text-xs text-slate-500">ID: <%= recordable.id %></div>
              <% if recordable.respond_to?(:created_at) && recordable.created_at.present? %>
                <div class="mt-1 text-xs text-slate-500">Created: <%= l(recordable.created_at, format: :short) %></div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </section>
</div>
