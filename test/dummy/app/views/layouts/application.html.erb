<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "RecordingStudio Sandbox" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Dummy">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="bg-[#FCFDFD] text-slate-900">
    <%= turbo_stream_from "recording_studio_toasts" %>
    <div class="min-h-screen bg-gradient-to-br from-[#FCFDFD] via-white to-[#FCFDFD]">
      <div class="flex min-h-screen" data-sidebar-shell>
        <% if user_signed_in? %>
          <aside class="group sticky top-0 flex h-screen w-72 flex-col border-r border-slate-200 bg-[#FCFDFD]/90 backdrop-blur transition-[width] duration-200 ease-in-out" data-sidebar>
            <div class="flex items-center justify-between px-3 py-4">
              <button type="button" class="flex items-center gap-2 pl-3 text-base font-semibold text-slate-900" data-sidebar-open aria-label="Open sidebar">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-900 text-sm font-semibold text-white">RS</span>
              </button>
              <button type="button" class="sidebar-toggle inline-flex h-9 w-9 items-center justify-center rounded-lg border border-slate-200 text-slate-600 transition hover:bg-slate-50" data-sidebar-toggle aria-label="Toggle sidebar">
                <span class="text-lg">&#9776;</span>
              </button>
            </div>
            <nav class="flex-1 px-3">
              <div class="space-y-1 text-sm">
                <%= link_to root_path, class: "grid grid-cols-[2rem_1fr] items-center rounded-lg px-3 py-2 text-slate-700 transition hover:bg-slate-100" do %>
                  <span class="inline-flex h-8 w-8 items-center justify-center">
                    <svg class="h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12 11.204 3.045a1.125 1.125 0 0 1 1.592 0L21.75 12M4.5 9.75V19.875c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75" />
                    </svg>
                  </span>
                  <span class="sidebar-label min-w-0 max-w-[12rem] overflow-hidden whitespace-nowrap transition-[opacity,max-width] duration-300 ease-in-out">Home</span>
                <% end %>
                <%= link_to pages_path, class: "grid grid-cols-[2rem_1fr] items-center rounded-lg px-3 py-2 text-slate-700 transition hover:bg-slate-100" do %>
                  <span class="inline-flex h-8 w-8 items-center justify-center">
                    <svg class="h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 10.125 2.25H8.25m0 0A2.25 2.25 0 0 0 6 4.5v15A2.25 2.25 0 0 0 8.25 21.75h7.5A2.25 2.25 0 0 0 18 19.5v-5.25m-9.75-12h1.875c.621 0 1.125.504 1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125h1.5c.621 0 1.125.504 1.125 1.125v2.625" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 12h7.5M8.25 15.75h7.5M8.25 9h3.75" />
                    </svg>
                  </span>
                  <span class="sidebar-label min-w-0 max-w-[12rem] overflow-hidden whitespace-nowrap transition-[opacity,max-width] duration-300 ease-in-out">Pages</span>
                <% end %>
                <%= link_to events_path, class: "grid grid-cols-[2rem_1fr] items-center rounded-lg px-3 py-2 text-slate-700 transition hover:bg-slate-100" do %>
                  <span class="inline-flex h-8 w-8 items-center justify-center">
                    <svg class="h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5A2.25 2.25 0 0 1 5.25 5.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 13.5h.008v.008H12V13.5Zm0 3h.008v.008H12v-.008Zm-3-3h.008v.008H9V13.5Zm0 3h.008v.008H9v-.008Zm6-3h.008v.008H15V13.5Zm0 3h.008v.008H15v-.008Z" />
                    </svg>
                  </span>
                  <span class="sidebar-label min-w-0 max-w-[12rem] overflow-hidden whitespace-nowrap transition-[opacity,max-width] duration-300 ease-in-out">Events</span>
                <% end %>
                <%= link_to recordings_path, class: "grid grid-cols-[2rem_1fr] items-center rounded-lg px-3 py-2 text-slate-700 transition hover:bg-slate-100" do %>
                  <span class="inline-flex h-8 w-8 items-center justify-center">
                    <svg class="h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 5.25h16.5M3.75 9h16.5M3.75 12.75h16.5M3.75 16.5h16.5M3.75 20.25h16.5" />
                    </svg>
                  </span>
                  <span class="sidebar-label min-w-0 max-w-[12rem] overflow-hidden whitespace-nowrap transition-[opacity,max-width] duration-300 ease-in-out">Recordings</span>
                <% end %>
                <%= link_to workspaces_path, class: "grid grid-cols-[2rem_1fr] items-center rounded-lg px-3 py-2 text-slate-700 transition hover:bg-slate-100" do %>
                  <span class="inline-flex h-8 w-8 items-center justify-center">
                    <svg class="h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 10.125 2.25H8.25m0 0A2.25 2.25 0 0 0 6 4.5v15A2.25 2.25 0 0 0 8.25 21.75h7.5A2.25 2.25 0 0 0 18 19.5v-5.25m-9.75-12h1.875c.621 0 1.125.504 1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125h1.5c.621 0 1.125.504 1.125 1.125v2.625" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 12h7.5M8.25 15.75h7.5M8.25 9h3.75" />
                    </svg>
                  </span>
                  <span class="sidebar-label min-w-0 max-w-[12rem] overflow-hidden whitespace-nowrap transition-[opacity,max-width] duration-300 ease-in-out">Workspaces</span>
                <% end %>
              </div>
            </nav>
            <div class="border-t border-slate-200 px-3 py-4">
              <%= button_to destroy_user_session_path,
                method: :delete,
                form: { class: "w-full" },
                class: "grid w-full grid-cols-[2rem_1fr] items-center rounded-lg px-3 py-2 text-left text-sm font-medium text-slate-600 transition hover:bg-slate-100" do %>
                <span class="inline-flex h-8 w-8 items-center justify-center">
                  <svg class="h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-7.5a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 6 21h7.5a2.25 2.25 0 0 0 2.25-2.25V15" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 12H9.75m0 0 2.25 2.25M9.75 12l2.25-2.25" />
                  </svg>
                </span>
                <span class="sidebar-label min-w-0 max-w-[12rem] overflow-hidden whitespace-nowrap transition-[opacity,max-width] duration-300 ease-in-out">Log out</span>
              <% end %>
            </div>
          </aside>
        <% end %>
        <div class="flex min-h-screen flex-1 flex-col">
          <header class="sticky top-0 z-10 bg-[#FCFDFD]/90 backdrop-blur">
            <div class="mx-auto flex w-full max-w-6xl items-center justify-end px-6 py-4">
              <div class="flex items-center gap-3">
                <% if admin_user? %>
                  <% grouped_options, selected_actor_selection, blank_label = actor_switcher_options(
                    current_actor: current_actor,
                    current_user: current_user,
                    true_user: true_user,
                    system_actors: system_actor_options,
                    impersonating: impersonating?
                  ) %>

                  <%= form_with url: actor_switch_path, method: :post, local: true, class: "flex items-center gap-3" do |form| %>
                    <%= form.label :actor_selection, "Actor", class: "text-sm font-medium text-slate-500" %>
                    <%= form.select :actor_selection, grouped_options_for_select(grouped_options, selected_actor_selection), { include_blank: blank_label }, class: "rounded-md border border-slate-200 bg-white/80 px-3 py-2 text-sm backdrop-blur", onchange: "this.form.requestSubmit()" %>
                  <% end %>
                <% end %>
              </div>
            </div>
          </header>
          <main class="mx-auto w-full max-w-6xl flex-1 px-6 pb-12">
            <% if flash[:notice].present? %>
              <div class="mb-6 rounded-md border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800">
                <%= flash[:notice] %>
              </div>
            <% end %>
            <% if flash[:alert].present? %>
              <div class="mb-6 rounded-md border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
                <%= flash[:alert] %>
              </div>
            <% end %>
            <%= yield %>
          </main>
        </div>
      </div>
    </div>
    <div id="toast-container" data-turbo-permanent class="pointer-events-none fixed inset-y-4 right-4 z-50 flex flex-col items-end gap-3"></div>
    <script>
      (() => {
        const shell = document.querySelector("[data-sidebar-shell]");
        const sidebar = document.querySelector("[data-sidebar]");
        const toggle = document.querySelector("[data-sidebar-toggle]");
        const openers = shell.querySelectorAll("[data-sidebar-open]");

        if (!shell || !sidebar || !toggle) return;

        const labels = shell.querySelectorAll(".sidebar-label");
        const labelTransitionMs = 300;
        const smallScreen = window.matchMedia("(max-width: 768px)");
        let collapsed = smallScreen.matches;

        const applyState = (animate) => {
          const expanded = !collapsed;

          if (expanded) {
            if (animate) {
              sidebar.classList.remove("w-20");
              sidebar.classList.add("w-72");
              labels.forEach((label) => {
                window.clearTimeout(label._collapseTimer);
                label.classList.remove("max-w-0", "pointer-events-none");
                label.classList.add("opacity-0");
              });
              window.setTimeout(() => {
                labels.forEach((label) => {
                  label.classList.remove("opacity-0");
                });
              }, labelTransitionMs);
            } else {
              sidebar.classList.remove("w-20");
              sidebar.classList.add("w-72");
              labels.forEach((label) => {
                window.clearTimeout(label._collapseTimer);
                label.classList.remove("max-w-0", "pointer-events-none", "opacity-0");
              });
            }
          } else {
            sidebar.classList.add("w-20");
            sidebar.classList.remove("w-72");
            labels.forEach((label) => {
              label.classList.add("opacity-0", "pointer-events-none");
              window.clearTimeout(label._collapseTimer);
              label._collapseTimer = window.setTimeout(() => {
                label.classList.add("max-w-0");
              }, labelTransitionMs);
            });
          }

          toggle.classList.toggle("opacity-0", collapsed);
          toggle.classList.toggle("pointer-events-none", collapsed);
        };

        applyState(false);

        toggle.addEventListener("click", () => {
          collapsed = !collapsed;
          applyState(true);
        });

        openers.forEach((opener) => {
          opener.addEventListener("click", () => {
            if (collapsed) {
              collapsed = false;
              applyState(true);
            }
          });
        });

      })();
    </script>
  </body>
</html>
